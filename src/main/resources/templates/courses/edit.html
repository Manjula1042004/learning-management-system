<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="'Edit ' + ${course.title} + ' - LMS'">Edit Course - LMS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 min-h-screen">
<!-- Navigation -->
<nav class="bg-white shadow-lg">
    <div class="max-w-7xl mx-auto px-4">
        <div class="flex justify-between items-center py-4">
            <div class="flex items-center">
                <a th:href="@{/}" class="flex items-center">
                    <span class="text-xl font-bold text-gray-800">LearnPro</span>
                </a>
            </div>
            <div class="flex items-center space-x-6">
                <a th:href="@{/courses}" class="text-gray-600 hover:text-blue-600">Courses</a>
                <a th:href="@{/instructor}" class="text-gray-600 hover:text-blue-600">Dashboard</a>
                <a th:href="@{/instructor/my-courses}" class="text-gray-600 hover:text-blue-600">My Courses</a>
            </div>
            <div class="flex items-center space-x-4">
                <div class="relative group">
                    <button class="flex items-center space-x-2 text-gray-600 hover:text-blue-600">
                        <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white text-sm font-semibold">
                            <span th:text="${user.username.substring(0, 1).toUpperCase()}">U</span>
                        </div>
                        <span th:text="${user.username}">User</span>
                        <i class="fas fa-chevron-down text-xs"></i>
                    </button>
                    <div class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-2 hidden group-hover:block z-50">
                        <a th:href="@{/profile}" class="block px-4 py-2 text-gray-800 hover:bg-blue-50">Profile</a>
                        <a th:href="@{/auth/logout}" class="block px-4 py-2 text-gray-800 hover:bg-blue-50">Logout</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</nav>

<main class="max-w-4xl mx-auto px-4 py-8">
    <div class="mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Edit Course</h1>
                <p class="text-gray-600 mt-2">Update your course information</p>
            </div>
            <a th:href="@{/courses/{id}(id=${course.id})}"
               class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400">
                <i class="fas fa-arrow-left mr-2"></i>Back to Course
            </a>
        </div>
    </div>

    <!-- Flash Messages -->
    <div th:if="${success}" class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
        <i class="fas fa-check-circle mr-2"></i>
        <span th:text="${success}"></span>
    </div>
    <div th:if="${error}" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
        <i class="fas fa-exclamation-triangle mr-2"></i>
        <span th:text="${error}"></span>
    </div>

    <div class="bg-white rounded-lg shadow-lg overflow-hidden">
        <div class="p-6 border-b border-gray-200 bg-gray-50">
            <h2 class="text-xl font-semibold text-gray-900">
                <i class="fas fa-edit text-blue-600 mr-2"></i>Course Information
            </h2>
        </div>

        <form th:action="@{/courses/{id}/edit(id=${course.id})}" method="post" enctype="multipart/form-data" class="p-6">
            <!-- CSRF token removed - matches security config -->

            <div class="grid grid-cols-1 gap-6">
                <!-- Course Title -->
                <div>
                    <label for="title" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-heading mr-1 text-gray-500"></i>Course Title <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="title" name="title" required th:value="${course.title}"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="Enter course title">
                </div>

                <!-- Course Description -->
                <div>
                    <label for="description" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-align-left mr-1 text-gray-500"></i>Description <span class="text-red-500">*</span>
                    </label>
                    <textarea id="description" name="description" rows="6" required
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                              placeholder="Describe what students will learn in this course"
                              th:text="${course.description}"></textarea>
                    <p class="text-xs text-gray-500 mt-1">Minimum 50 characters recommended</p>
                </div>

                <!-- Course Price -->
                <div>
                    <label for="price" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-dollar-sign mr-1 text-gray-500"></i>Price ($)
                    </label>
                    <div class="relative">
                        <span class="absolute left-3 top-2 text-gray-500">$</span>
                        <input type="number" id="price" name="price" step="0.01" min="0" required
                               th:value="${course.price}"
                               class="w-full pl-8 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="0.00">
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Set to 0 for free courses</p>
                </div>

                <!-- Course Status (Read-only) -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-info-circle mr-1 text-gray-500"></i>Course Status
                    </label>
                    <div class="flex items-center">
                        <span th:text="${course.status}"
                              th:class="${course.status == 'APPROVED' ? 'bg-green-100 text-green-800' :
                                         course.status == 'PENDING' ? 'bg-yellow-100 text-yellow-800' :
                                         'bg-red-100 text-red-800'} + ' px-3 py-1 rounded-full text-sm font-medium'">
                        </span>
                        <span class="ml-3 text-sm text-gray-500">
                            Created: <span th:text="${#temporals.format(course.createdAt, 'MMM dd, yyyy')}"></span>
                        </span>
                    </div>
                </div>

                <!-- Thumbnail Section -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-3">
                        <i class="fas fa-image mr-1 text-gray-500"></i>Course Thumbnail
                    </label>

                    <!-- Current Thumbnail Preview -->
                    <div th:if="${course.thumbnailUrl != null and !course.thumbnailUrl.isEmpty()}"
                         class="mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <p class="text-sm font-medium text-gray-700 mb-3">Current Thumbnail:</p>
                        <div class="flex items-start space-x-4">
                            <div class="w-32 h-32 rounded-lg overflow-hidden border border-gray-300 shadow-sm">
                                <img th:src="${course.thumbnailUrl}" alt="Current thumbnail"
                                     class="w-full h-full object-cover">
                            </div>
                            <div class="flex-1">
                                <p class="text-sm text-gray-600">
                                    <i class="fas fa-cloud mr-1 text-blue-500"></i>
                                    <span th:if="${course.thumbnailUrl.contains('cloudinary.com')}">
                                        Stored in Cloudinary
                                    </span>
                                    <span th:unless="${course.thumbnailUrl.contains('cloudinary.com')}">
                                        External URL
                                    </span>
                                </p>
                                <p class="text-xs text-gray-500 mt-2">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    Upload a new image below to replace this thumbnail
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- New Thumbnail Upload -->
                    <div class="mt-2">
                        <label for="thumbnail" class="block text-sm font-medium text-gray-700 mb-2">
                            Upload New Thumbnail <span class="text-gray-500 text-xs">(optional)</span>
                        </label>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 hover:border-blue-500 transition-colors cursor-pointer"
                             id="dropArea">
                            <input type="file" id="thumbnail" name="thumbnail" accept="image/*" class="hidden">
                            <div class="text-center">
                                <i class="fas fa-cloud-upload-alt text-gray-400 text-4xl mb-3"></i>
                                <p class="text-gray-600 mb-2">Drag & drop or <span class="text-blue-600 hover:underline">click to upload</span></p>
                                <p class="text-xs text-gray-500">JPG, PNG, GIF • Max 5MB</p>
                            </div>
                        </div>
                        <div id="previewContainer" class="hidden mt-4">
                            <p class="text-sm font-medium text-gray-700 mb-2">New Thumbnail Preview:</p>
                            <img id="imagePreview" class="h-32 rounded-lg border border-gray-300 shadow-sm">
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex justify-end space-x-4 pt-6 border-t border-gray-200">
                    <a th:href="@{/courses/{id}(id=${course.id})}"
                       class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                        Cancel
                    </a>
                    <button type="submit"
                            class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center">
                        <i class="fas fa-save mr-2"></i>Save Changes
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Danger Zone - Delete Course -->
    <div class="mt-8 bg-red-50 border border-red-200 rounded-lg overflow-hidden">
        <div class="p-6 border-b border-red-200 bg-red-100">
            <h2 class="text-lg font-semibold text-red-800 flex items-center">
                <i class="fas fa-exclamation-triangle mr-2"></i>Danger Zone
            </h2>
        </div>
        <div class="p-6">
            <p class="text-red-700 mb-4">
                <i class="fas fa-exclamation-circle mr-1"></i>
                Once you delete a course, all lessons, student enrollments, and associated data will be permanently removed. This action cannot be undone.
            </p>

            <form th:action="@{/courses/{id}/delete(id=${course.id})}" method="post"
                  onsubmit="return confirmDelete()">
                <!-- CSRF token removed - matches security config -->
                <button type="submit"
                        class="bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition-colors flex items-center">
                    <i class="fas fa-trash mr-2"></i>Delete Course Permanently
                </button>
            </form>
        </div>
    </div>
</main>

<!-- Footer -->
<footer class="bg-gray-800 text-white py-8 mt-12">
    <div class="max-w-7xl mx-auto px-4 text-center">
        <p>&copy; 2024 Learning Management System. All rights reserved.</p>
    </div>
</footer>

<script>
    // File upload handling
    document.addEventListener('DOMContentLoaded', function() {
        const dropArea = document.getElementById('dropArea');
        const fileInput = document.getElementById('thumbnail');
        const previewContainer = document.getElementById('previewContainer');
        const imagePreview = document.getElementById('imagePreview');

        if (dropArea && fileInput) {
            // Click on drop area to trigger file input
            dropArea.addEventListener('click', function() {
                fileInput.click();
            });

            // Drag and drop events
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, unhighlight, false);
            });

            function highlight() {
                dropArea.classList.add('border-blue-500', 'bg-blue-50');
            }

            function unhighlight() {
                dropArea.classList.remove('border-blue-500', 'bg-blue-50');
            }

            dropArea.addEventListener('drop', handleDrop, false);

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                fileInput.files = files;
                previewFile();
            }

            // File input change event
            fileInput.addEventListener('change', previewFile);
        }

        // Preview selected file
        function previewFile() {
            const file = fileInput.files[0];
            if (!file) return;

            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file (JPEG, PNG, GIF, etc.)');
                fileInput.value = '';
                return;
            }

            // Validate file size (5MB max)
            if (file.size > 5 * 1024 * 1024) {
                alert('File size must be less than 5MB');
                fileInput.value = '';
                return;
            }

            // Show preview
            const reader = new FileReader();
            reader.onload = function(e) {
                imagePreview.src = e.target.result;
                previewContainer.classList.remove('hidden');
            }
            reader.readAsDataURL(file);
        }

        // Dropdown functionality
        document.querySelectorAll('.group').forEach(group => {
            group.addEventListener('click', function(e) {
                e.stopPropagation();
                const menu = this.querySelector('.hidden');
                if (menu) {
                    menu.classList.toggle('hidden');
                }
            });
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.group')) {
                document.querySelectorAll('.group .hidden').forEach(menu => {
                    menu.classList.add('hidden');
                });
            }
        });
    });

    // Confirm delete function
    function confirmDelete() {
        return confirm('⚠️ WARNING: Are you absolutely sure you want to delete this course?\n\nThis will permanently delete:\n• All lessons in this course\n• All student enrollments\n• All quizzes and progress data\n\nThis action CANNOT be undone!');
    }
</script>
</body>
</html>